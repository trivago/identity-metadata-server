name: 'identity-server unit tests'

'on':
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'cmd/identity-server/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'

jobs:
  test-identity-server:
    if: github.actor != 'github-actions[bot]'

    runs-on: ['ubuntu-24.04']
    defaults:
      run:
        shell: 'bash'
    steps:
      - name: 'setup golang'
        uses: 'actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00' # ratchet:actions/setup-go@v6
        with:
          go-version: '1.24.3'

      - name: 'checkout'
        uses: 'actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8' # ratchet:actions/checkout@v5
        id: checkout

      - name: 'run tests'
        run: |
          go test -tags=jsoniter -ldflags="-s -w" -mod=mod -cover -coverprofile=coverage.txt -v ./cmd/identity-server/...

      - name: Archive code coverage results
        uses: 'actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02' # ratchet:actions/upload-artifact@v4
        with:
          name: 'identity-server-coverage'
          path: 'coverage.txt'

  code-coverage:
    name: 'Code coverage report'
    needs: 'test-identity-server'
    runs-on: ['ubuntu-24.04']

    permissions:
      contents: 'read'
      actions: 'read'
      pull-requests: 'write'

    steps:
      - uses: 'fgrosse/go-coverage-report@8c1d1a09864211d258937b1b1a5b849f7e4f2682' # ratchet:fgrosse/go-coverage-report@v1.2.0
        env:
          GITHUB_BASELINE_WORKFLOW: ${{ github.workflow }}
        with:
          coverage-artifact-name: 'identity-server-coverage'
          coverage-file-name: 'coverage.txt'
